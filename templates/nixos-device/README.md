# NixOS Device Flake (per‑host)

This template creates a small, per‑device flake that consumes your public `nixfiles` as a generator via `nixfiles.lib.mkSystem`. It keeps device‑specific state (hardware config, host selection, and optional secrets) local to the machine under `/etc/nixos`.

## Layout

- `flake.nix`: Uses `inputs.nixfiles = path:./nixfiles` and builds `nixosConfigurations.${host}` via `nixfiles.lib.mkSystem`.
- `flake.lock`: Pins the local `./nixfiles` input for pure evaluation.
- `host.nix`: A single string with your host name (e.g. `"argo"`).
- `hardware-configuration.nix`: Generated by `nixos-generate-config --root /mnt` during install.
- `nixfiles/`: A copy of your public nixfiles (embedded by the installer for offline use).

## Typical install flow (via netboot installer)

1) Partition and mount (auto or manual), then run the installer helper:
   - `sudo install-host <host>`
   - This writes `/mnt/etc/nixos` with the device flake, copies embedded `nixfiles/`, sets `host.nix`, ensures `hardware-configuration.nix`, and runs:
     - `nixos-install --flake /mnt/etc/nixos#<host>`

2) First boot on the device:
   - Rebuild locally any time with:
     - `cd /etc/nixos && sudo nixos-rebuild switch --flake .#<host>`

## Changing which host to build

- Edit `host.nix` and set it to one of the directories under `nixfiles/hosts/`.
- Example: `echo '"venator"' | sudo tee /etc/nixos/host.nix`

## Updating nixfiles after install

There are two common options:

- Stay on the local copy (offline‑friendly):
  - Replace the contents of `/etc/nixos/nixfiles/` with a fresh copy of your public repo.
  - Then run: `cd /etc/nixos && sudo nix flake lock --update-input nixfiles`.

- Switch to the upstream repo (recommended for long‑term):
  - Edit `/etc/nixos/flake.nix` and change:
    - `inputs.nixfiles.url = "path:./nixfiles";`
    - To something like: `inputs.nixfiles.url = "github:<user>/<repo>";`
  - Then run: `cd /etc/nixos && sudo nix flake lock --update-input nixfiles`

## Secrets and private modules

- Keep device‑specific secrets (e.g., SSH keys, tokens) under `/etc/nixos/` and import them via modules in the device flake.
- Do not commit secrets into the public nixfiles repo.

## Architecture

- The template defaults to `x86_64-linux`. If your device is a different architecture, add a `system` binding (e.g., import `./system.nix`) and pass it to `nixfiles.lib.mkSystem`.

## Safety notes

- `hardware-configuration.nix` comes from the target machine and will reference the correct UUIDs.
- The local `nixfiles/` copy is used for pure evaluation. You can switch to an upstream input later without re‑installing.

